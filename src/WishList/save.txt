const isFocused = useIsFocused();
const { loading, error } = useAuthGuard();
const [wishListDetail, setWishListsDetail] =
  useState<WishListDetailResponse | null>(null);
const [showNotification, setShowNotification] = useState<string | null>(null);
const [typeNotification, setTypeNotification] = useState<'success' | 'error'>(
  'success',
);
const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
const [selectedId, setSelectedId] = useState<string | null>(null);
useEffect(() => {
  loadWishListsDetail();
}, []);
const handleLogin = () => {
  navigation.navigate('login', {
    redirect: 'homeTab',
    params: 'paymentScreen',
  });
};
if (loading) return <LoadingView message="Đang kiểm tra đăng nhập ..." />;
if (error)
  return (
    <ErrorView
      message="Bạn cần đăng nhập để sử dụng tính năng này"
      onPress={handleLogin}
    />
  );
const loadWishListsDetail = async () => {
  const res = await getWishListDetail(route?.params.wishListId);
  if (res?.message) {
    setTypeNotification('success');
    setWishListsDetail(res.wishListDetail);
  } else {
    setTypeNotification('error');
  }
  setShowNotification(res?.message);
};
const handleDelete = async () => {
  if (!wishListDetail?.id || !selectedId) {
    setTypeNotification('error');
    setShowNotification('Undefined Id WishList or Undefined Id Exp ');
    setShowDeleteConfirm(false);
    return;
  }
  const res = await removeExpToWishList(wishListDetail?.id, selectedId);
  if (res?.isSuccess) {
    setWishListsDetail(prev =>
      prev
        ? {
            ...prev,
            experiences: prev.experiences.filter(
              exp => exp.id !== selectedId,
            ),
          }
        : prev,
    );
    setTypeNotification('success');
  } else {
    setTypeNotification('error');
  }
  setShowNotification(res?.message);
  setShowDeleteConfirm(false);
};
return (
  <ScrollView style={styles.container} showsVerticalScrollIndicator={false}>
    {/* Tiêu đề + avatar thêm người */}
    <View style={styles.headerRow}>
      <Text style={styles.headerText}>{wishListDetail?.name}</Text>
      <Text>{wishListDetail?.experiences.length}</Text>
    </View>{' '}
    {wishListDetail?.experiences.length === 0 && (
      <View style={styles.emptyContainer}>
        <Text style={styles.emptyText}>
          Danh sách này chưa có trải nghiệm nào
        </Text>
        <TouchableOpacity
          style={styles.emptyButton}
          onPress={() => navigation.navigate('homeTab')}
        >
          <Text style={styles.emptyButtonText}>Khám phá trải nghiệm</Text>
        </TouchableOpacity>
      </View>
    )}
    {wishListDetail?.experiences.map(item => (
      <WishListDetailCard
        key={item.id}
        title={item.title}
        subtitle={item.description}
        price={item.adultPrice}
        rating="5.0"
        reviews="799 đánh giá"
        image={item.media[0]}
        onPress={() => navigation.navigate('tourDetail', { id: item.id })}
        onLongPress={() => {
          setSelectedId(item.id);
          setShowDeleteConfirm(true);
        }}
      />
    ))}
    {showNotification && isFocused && (
      <Notification
        message={showNotification}
        onClose={() => setShowNotification(null)}
        type={typeNotification}
        autoClose
        position="bottom"
        duration={3000}
      />
    )}
    {showDeleteConfirm && (
      <ConfirmModal
        key={showDeleteConfirm ? 'delete-visible' : 'delete-hidden'}
        visible={showDeleteConfirm}
        message="Bạn có chắc muốn xóa trải nghiệm này khỏi danh sách?"
        onClose={() => setShowDeleteConfirm(false)}
        onConfirm={handleDelete}
      />
    )}
  </ScrollView>
);